<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>code 空间</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="微信搜索 [优趣知识星球]关注我，更多精彩内容早知道">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="./assets/css/0.styles.1283b671.css" as="style"><link rel="preload" href="./assets/js/app.2d19893c.js" as="script"><link rel="preload" href="./assets/js/2.40a7d224.js" as="script"><link rel="preload" href="./assets/js/1.81a858bd.js" as="script"><link rel="preload" href="./assets/js/30.f271357f.js" as="script"><link rel="prefetch" href="./assets/js/10.6f279210.js"><link rel="prefetch" href="./assets/js/11.84eab169.js"><link rel="prefetch" href="./assets/js/12.ad928c04.js"><link rel="prefetch" href="./assets/js/13.9eb7cac0.js"><link rel="prefetch" href="./assets/js/14.a0a94b42.js"><link rel="prefetch" href="./assets/js/15.c58efa63.js"><link rel="prefetch" href="./assets/js/16.9b8980d4.js"><link rel="prefetch" href="./assets/js/17.644c05fc.js"><link rel="prefetch" href="./assets/js/18.a0e229f5.js"><link rel="prefetch" href="./assets/js/19.d47005b6.js"><link rel="prefetch" href="./assets/js/20.c31295ea.js"><link rel="prefetch" href="./assets/js/21.9582cc51.js"><link rel="prefetch" href="./assets/js/22.f28d93a3.js"><link rel="prefetch" href="./assets/js/23.51420fa7.js"><link rel="prefetch" href="./assets/js/24.dab83daa.js"><link rel="prefetch" href="./assets/js/25.d61eef8d.js"><link rel="prefetch" href="./assets/js/26.f84f5795.js"><link rel="prefetch" href="./assets/js/27.d555393e.js"><link rel="prefetch" href="./assets/js/28.1fc0d219.js"><link rel="prefetch" href="./assets/js/29.692abbea.js"><link rel="prefetch" href="./assets/js/3.a66b692d.js"><link rel="prefetch" href="./assets/js/31.13d046be.js"><link rel="prefetch" href="./assets/js/32.00661df3.js"><link rel="prefetch" href="./assets/js/33.e8dabac9.js"><link rel="prefetch" href="./assets/js/34.91df3073.js"><link rel="prefetch" href="./assets/js/35.9cb9c7e8.js"><link rel="prefetch" href="./assets/js/36.b0ae10e8.js"><link rel="prefetch" href="./assets/js/37.555c866a.js"><link rel="prefetch" href="./assets/js/38.9ae71095.js"><link rel="prefetch" href="./assets/js/39.db54ba90.js"><link rel="prefetch" href="./assets/js/4.86591a69.js"><link rel="prefetch" href="./assets/js/40.b3efe4c9.js"><link rel="prefetch" href="./assets/js/41.840a5da5.js"><link rel="prefetch" href="./assets/js/42.8ae605cc.js"><link rel="prefetch" href="./assets/js/43.f4cda556.js"><link rel="prefetch" href="./assets/js/44.c5c8caca.js"><link rel="prefetch" href="./assets/js/45.4e2a8531.js"><link rel="prefetch" href="./assets/js/5.25bb60ab.js"><link rel="prefetch" href="./assets/js/6.045e8e65.js"><link rel="prefetch" href="./assets/js/7.63faf862.js"><link rel="prefetch" href="./assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="./assets/css/0.styles.1283b671.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">code 空间</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://gitee.com/ten_days" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/ten_days/vigo-ui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人组件库vigo-ui-caifw
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://gitee.com/ten_days" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/ten_days/vigo-ui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人组件库vigo-ui-caifw
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/./大前端/" class="sidebar-heading clickable open"><span>大前端</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/./大前端/JavaScript基础/" class="sidebar-heading clickable open"><span>JavaScript基础</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/./大前端/JavaScript基础/数据类型.html" class="sidebar-link">数据类型</a></li><li><a href="/./大前端/JavaScript基础/循环语句.html" class="sidebar-link">循环语句</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列-函数(function).html" class="sidebar-link">函数</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列-函数调用之apply、call、bind.html" class="sidebar-link">函数调用</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——数组、数组常用方法.html" class="sidebar-link">数组</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——原型、原型链、继承.html" class="sidebar-link">原型链</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——闭包.html" class="sidebar-link">闭包</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——this指向.html" class="sidebar-link">this</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——正则表达式.html" class="sidebar-link">正则表达式</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——同步与异步.html" class="active sidebar-link">同步与异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./大前端/JavaScript基础/JavaScript系列——同步与异步.html#概要" class="sidebar-link">概要</a></li><li class="sidebar-sub-header"><a href="/./大前端/JavaScript基础/JavaScript系列——同步与异步.html#javascript运行机制" class="sidebar-link">JavaScript运行机制</a></li><li class="sidebar-sub-header"><a href="/./大前端/JavaScript基础/JavaScript系列——同步与异步.html#异步场景" class="sidebar-link">异步场景</a></li><li class="sidebar-sub-header"><a href="/./大前端/JavaScript基础/JavaScript系列——同步与异步.html#异步编程优化" class="sidebar-link">异步编程优化</a></li><li class="sidebar-sub-header"><a href="/./大前端/JavaScript基础/JavaScript系列——同步与异步.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——Promise.html" class="sidebar-link">Promise</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——Generator.html" class="sidebar-link">Generator</a></li><li><a href="/./大前端/JavaScript基础/JavaScript系列——Proxy（代理）.html" class="sidebar-link">Proxy（代理）</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/./大前端/浏览器/" class="sidebar-heading clickable"><span>浏览器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/./大前端/开发实战/" class="sidebar-heading clickable"><span>开发实战</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>@[toc]</p> <h2 id="概要"><a href="#概要" class="header-anchor">#</a> 概要</h2> <p>异步，按照字面理解，指的是<code>两个或者两个以上的对象或事件</code>不同时存在或者发生（或者`多个相关事物的发生无需等待其一事物的完成），在JavaScript引擎中，</p> <p>异步是相对于同步来说，所谓同步，大致可以理解为：代码执行顺序是<code>按照其在脚本的顺序来执行</code>（变量提升除外），脚本必须执行完上一句代码，才能接着执行下一句语句。</p> <p>在大多数情况下，这个是符合我们<code>专注做一件事情的场景</code>，但有时候，遇到一些<code>很耗时间的任务</code>，如果采取同步的方法，会<code>影响后续任务的执行</code>，只能<code>等待这个耗时任务执行完</code>，<code>才能接着执行其他任务</code>，从而影响整体的效率。</p> <p>为了解决这种耗时费力的任务处理，JavaScript为我们提供了<code>异步处理</code>。所谓异步，可以理解为：把<code>耗时的任务交给单独的线程去处理</code>，同时注册一个<code>回调函数</code>。紧接着，<code>JavaScript引擎无需等待</code>这个任务处理完成，可以接着运行下面的语句。
等到那个单独线程处理完成任务后，告诉JavaScript引擎，JavaScript再执行其注册的回调函数。这个就是异步。</p> <h3 id="同步代码"><a href="#同步代码" class="header-anchor">#</a> 同步代码：</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;Miriam&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> greeting <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>greeting<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;Hello, my name is Miriam!&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这段代码：</p> <ol><li>声明了一个叫做 name 的字符串常量</li> <li>声明了另一个叫做 greeting 的字符串常量（并使用了 name 常量的值）</li> <li>将 greeting 常量输出到 JavaScript 控制台中。</li></ol> <h3 id="异步代码"><a href="#异步代码" class="header-anchor">#</a> 异步代码</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/bar/foo.txt&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;比最后一段代码执行更晚&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;执行语句&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>第 2 行中指定第三个参数为 true，表示该请求应该以异步模式执行。</p> <p>第 3 行创建一个事件处理函数对象，并将其分配给请求的 onload 属性。此处理程序查看请求的 readyState，以查看事务是否在第 4 行完成，如果是，并且 HTTP 状态为 200，则转储接收到的内容。如果发生错误，则显示错误消息。</p> <p>第 15 行实际上启动了请求。只要请求的状态发生变化，就会调用回调程序。
发起请求后，<code>立马执行console.log(&quot;执行语句&quot;)</code>，等待请求状态发送变化，才会触发onload注册的函数，接着执行<code>console.log(&quot;比最后一段代码执行更晚&quot;)</code></p> <h2 id="javascript运行机制"><a href="#javascript运行机制" class="header-anchor">#</a> JavaScript运行机制</h2> <p>通过上面的代码演示，我们可以发现，JavaScript有自己的一套运行机制，这套机制称之为<code>事件循环</code>，像异步处理这些属于<code>事件循环的并发模型</code>机制。
事件循环负责执行代码，收集和处理事件以及执行任务队列中的子任务。
任务队列子任务，可以理解为异步事件注册的回调函数。</p> <h3 id="运行时概念"><a href="#运行时概念" class="header-anchor">#</a> 运行时概念</h3> <p>接下来的内容解释了这个理论模型。现代 JavaScript 引擎实现并着重优化了以下描述的这些语义。
<img src="https://img-blog.csdnimg.cn/direct/8962e8e9c63d4d1ba700ed5616b4b130.png" alt="在这里插入图片描述"></p> <h3 id="栈-stack"><a href="#栈-stack" class="header-anchor">#</a> 栈（stack）</h3> <p>函数调用形成了一个由若干帧组成的栈。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">(</span>x <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回 42</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol><li>当调用bar 函数，第一个帧被创建并压入栈中，帧中包含了bar 的参数和局部变量。</li> <li>当bar 调用foo 时，第二个帧被创建并被压入栈中，放在第一个帧上面，帧中包含了foo 的参数和局部变量</li> <li>当foo执行完毕后返回时，第二个帧就被弹出栈（剩下bar函数的调用帧）</li> <li>当bar 执行完毕后，第一个帧也被弹出，栈就被清空了。</li></ol> <h3 id="堆"><a href="#堆" class="header-anchor">#</a> 堆</h3> <p><code>对象被分配在堆中</code>，堆是一个用来表示一大块（通常是非结构化的）内存区域的计算机术语。</p> <h3 id="队列"><a href="#队列" class="header-anchor">#</a> 队列</h3> <p>一个JavaScript运行时，包含一个待处理的消息队列，每一个消息都关联着一个用来处理这个消息的回调函数。</p> <p><code>队列和栈的元素被处理顺序是相反的</code>，<code>队列是先进先出</code>，和我们生活中先来后到的排队机制一样。因此，先被添加的消息，先执行，消息要被全部执行完毕，才能执行下一个消息。</p> <p>在事件循环期间的某个时刻，运行时会<code>从最先进入队列的消息</code>开始处理队列中的消息。被处理完成的消息会<code>被移除队列</code>，并<code>作为输入参数</code>来调用与之<code>关联的函数</code>(也就是回调函数），正如前面所提到的，调用一个函数总是会为其创造一个新的栈帧。</p> <p>函数处理一直进行到执行栈为空为止，然后事件循环将会处理下一个消息。</p> <h3 id="消息的添加"><a href="#消息的添加" class="header-anchor">#</a> 消息的添加</h3> <p>我们在上面了解到，队列用来存储消息，先被添加的消息先处理，那么，消息是何时被添加到消息队列的呢？</p> <p>JavaScript 中，每当<code>一个指定的事件真实发生了</code>，并且<code>绑定了相应回调函数</code>，一个消息就会被<code>添加到消息队列</code>。如果这个事件没有回调函数，这个事件将会丢失。</p> <p>就像我们给某个元素绑定了点击事件，实际上只是给某个元素注册了一个点击事件，这个事件注册的回调代码，不会立马执行。而是用户真实点击这个元素时，这个点击事件才会真实发生，然后把消息添加到消息队列。如果此时消息队列，前面还有消息，那么会将点击事件的消息排在后面，等待前面消息处理完成才处理这个消息，并调用相应的回调函数。</p> <p>例如以下代码：</p> <p>函数 setTimeout 接受两个参数：<code>待加入队列的消息</code>和一个时间值（可选，默认为 0）。这个时间值代表了消息被实际加入到队列的最小延迟时间。如果队列中<code>没有其他消息并且栈为空</code>，在<code>这段延迟时间过去之后，消息会被马上处理</code>。但是，如果<code>有其他消息</code>，<code>setTimeout 消息必须等待其他消息处理完</code>。因此第二个参数仅仅表示最少延迟时间，而非确切的等待时间。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;这是开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;这是来自第一个回调的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;这是一条消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cb1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;这是来自第二个回调的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;这是结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// &quot;这是开始&quot;</span>
<span class="token comment">// &quot;这是一条消息&quot;</span>
<span class="token comment">// &quot;这是结束&quot;</span>
<span class="token comment">// &quot;这是来自第一个回调的消息&quot;</span>
<span class="token comment">// &quot;这是来自第二个回调的消息&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>因为cb()，也是延迟0秒，因此先被添加到消息队列。cb1排在其后面，因此晚执行。
基本上，setTimeout 需要等待当前队列中所有的消息都处理完毕之后才能执行，即使已经超出了由第二参数所指定的时间。</p> <h2 id="异步场景"><a href="#异步场景" class="header-anchor">#</a> 异步场景</h2> <h3 id="网络请求"><a href="#网络请求" class="header-anchor">#</a> 网络请求</h3> <p>JavaScript处理后台接口请求，一般都是使用<code>XMLHttpRequest</code> 进行异步请求。如流行的<code>axios</code>库，也是基于<code>XMLHttpRequest</code>。</p> <p>下面代码演示axios 请求接口</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">//为给定 ID 的 user 创建请求</span>
axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user?ID=12345'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面代码，使用axios  的get方法发起一个get请求，在then 注册接口成功返回的函数。
最后console.log(&quot;123&quot;)的语句一般先于console.log(response);执行。</p> <ol><li>JavaScript将网络请求交给<code>网络请求线程处理</code>，JavaScript引擎此时不需要等待其执行完毕，就可以接着执行console.log(&quot;123&quot;)</li> <li>如果请求接口返回了数据，这个时候，JavaScript会将消息添加到消息队列，如果此时队列没有其他消息，便可以立即处理这个消息，然后调用其关联的回调函数：function (response) {console.log(response);}</li></ol> <p>网络请求线程与JavaScript引擎工作如下图所示：
<img src="https://img-blog.csdnimg.cn/direct/ea50a4fdb42f4143a507b149584f3a99.png" alt="在这里插入图片描述"></p> <p>以 Chrome 为例，浏览器<code>不仅有多个线程</code>，还有<code>多个进程</code>，如<code>渲染进程、GPU 进程和插件进程</code>等。
每个 tab 标签页都是一个独立的渲染进程，所以一个 tab 异常崩溃后，其他 tab 基本不会被影响。
渲染进程下<code>包含了 JS 引擎线程、HTTP 请求线程和定时器线程</code>等，这些线程为 JS 在浏览器中完成异步任务提供了基础。</p> <h2 id="异步编程优化"><a href="#异步编程优化" class="header-anchor">#</a> 异步编程优化</h2> <p>在我们日常编程中，需要用到很多关于异步编程的地方，比如网络请求，很多时候，碰到一些复杂的需求，比如请求A ，返回结果后，需要作为请求B的参数，请求B返回结果，需要作为 C的请求参数，如果用普通的异步编程，可以得到以下的代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'B'</span>，reA<span class="token punctuation">)</span>
		  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reB</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'C'</span>，reB<span class="token punctuation">)</span>
			  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reC</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;请求完成&quot;</span><span class="token punctuation">)</span>
			  <span class="token punctuation">}</span><span class="token punctuation">)</span>
			  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">errorC</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>errorC<span class="token punctuation">)</span><span class="token punctuation">;</span>
			  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span><span class="token punctuation">)</span>
		  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">errorB</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>errorB<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">errorA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>errorA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>以上代码我们称为<code>回调地狱</code>,就是多层回调嵌套，造成可读性和可维护性难度加大。
为了解决上诉的问题，ES6提供了 <code>promise</code> 。</p> <p>我们可以使用promise 来优化上面的回调地狱程序</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">geAllData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resA <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> resB <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span>resA<span class="token punctuation">)</span>
    <span class="token keyword">const</span> resC <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span>resB<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;请求完成&quot;</span><span class="token punctuation">,</span>resC<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>params<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">geAllData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;geAllData调用后立马执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>上面的代码中，getData 函数里面，我们返回一个Promise 的实例对象，其中传入一个回调函数，参数为resolve, reject，当我们接口<code>返回成功时调用resolve</code>，<code>失败则调用reject</code>。</p> <p>geAllData 函数使用了 <code>async</code> 关键字，告诉JavaScript，这个是一个异步函数，这个函数里面可以使用<code>await</code>关键字。</p> <p>await关键字可以从字面上理解，<code>就是等待</code>，等待接口getData 函数执行完resolve语句，代码才会继续往下执行，如果一直没有调用resolve或者reject，那么，就会一直等待，不会执行下面的语句。</p> <p>通过await 获取的值，就是<code>resolve 函数的参数值</code>，比如<code>const resA</code>就是 resolve(<code>res</code>)中<code>res</code> 的值。</p> <p><code>注意事项</code>
同步只有发生在async  修饰的函数内部，在外部还是不影响其他代码执行的。比如console.log(&quot;geAllData调用后立马执行&quot;) 语句<code>不会等待geAllData 执行完console.log(&quot;请求完成&quot;,resC)</code> 才执行,<code>而是调用geAllData函数后，立马执行的</code>。</p> <p>通过上面的优化，我们可以将异步的代码，<code>以同步代码的写法</code>来实现，这样提高了代码可读性，后续文章会针对Promise 做一个详细介绍。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ol><li>JavaScript引擎是单线程的，它通过<code>事件循环机制</code>来不断处理消息队列的消息</li> <li>消息队列的消息只有对应的事件<code>真实发生</code>，并<code>绑定了相应的回调函数</code>，才会被<code>添加</code>到消息队列</li> <li>消息队列先被添加的消息先被处理（<code>先进先出</code>）</li> <li>JavaScript引擎处理异步任务，是交给另外线程去处理，等另一个线程处理完成，才把消息添加到JavaScript运行时的消息队列。</li> <li>setTimeout 延时0 秒，<code>不代表0秒后立马执行</code>，要看延时到指定时间后，<code>消息队列有无排在其前面的消息</code>，如果有，则要先处理前面的消息，才执行延时任务。</li> <li>回调地狱可以使用<code>Promise+async+await</code>优化</li> <li>async修饰的函数内部，用await处理是同步执行的，而async函数外部，不受影响。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./大前端/JavaScript基础/JavaScript系列——正则表达式.html" class="prev">
        正则表达式
      </a></span> <span class="next"><a href="/./大前端/JavaScript基础/JavaScript系列——Promise.html">
        Promise
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.2d19893c.js" defer></script><script src="./assets/js/2.40a7d224.js" defer></script><script src="./assets/js/1.81a858bd.js" defer></script><script src="./assets/js/30.f271357f.js" defer></script>
  </body>
</html>
