@[toc]
## 浏览器渲染流程
### 资源请求
当我们在地址栏输入目标地址的时候，浏览器首先需要进行资源请求。在资源请求过程中，浏览器会用一些机制来加快资源的响应，下面是资源请求的全过程：
####  DNS 查询
当我们输入目标的域名的时候，客户端需要找到对应资源的位置。例如输入https://example.com HTML页面被定为到112.12.12.12 的服务器，如果之前没有访问过这个网站，就需要`进行DNS查询`，即`通过域名来获取对应的IP地址`。

DNS 查询，是浏览器向域名服务器发起一个DNS 请求，最终这个域名服务器返回一个`IP地址`。这个IP地址就是浏览器获取资源的真实路径。第一个向DNS 查询得到IP后，浏览器会将IP于域名匹配存入缓存中，一段时间内，直接从缓存获取即可，无需向DNS服务器获取。

如果`字体、图片、脚本等资源的域名不同`，则需要对`每一个域名都进行一次DNS查询`。

#### TCP握手
通过DNS服务器获取到IP地址后，客户端要向目标主机，`发起会话连接`，此时`需要先通过TCP进行三次握手`，这个发生`在http发送数据之前`，通过TCP握手，可以`协商网络套接字连接`的一些`参数`。

之所以要进行三次握手，是为了确认连接的可靠性和稳定性，避免潜在的网络问题导致的资源浪费和传输混乱。

如果只是进行两次握手，`有可能一方未做好准备`而`一方已做好连接准备好的情况`，或者`客户端在第一次发送SYN后`，`宕机`，`重新连接后`，可能收到数据是宕机前发送的请求与重新连接请求不一致。

#### TSL协商

如果发起的是`https `请求，还需要另一次握手，这个握手，就是`TLS协商`，`决定了使用哪种密码对通信进行加密`，验证服务器。并在实际传输前建立安全连接，这就需要在`实际发送内容之前`，`在建立TCP连接之后`，再往返`服务器五次`。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/29fd5ddfc1ed4a638f1aef8a3fe1c05b.png)

### 响应
经过 8 次往返，浏览器终于可以发出请求。`当浏览器发送一个http请求时`，这个请求通常是`HTML文件`，一旦`服务器收到请求`，他就使用`相关的响应头`和`HTML内容`进行回复

```html
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>简单的页面</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="myscript.js"></script>
  </head>
  <body>
    <h1 class="heading">我的页面</h1>
    <p>含有<a href="https://example.com/about">链接</a>的段落。</p>
    <div>
      <img src="myimage.jpg" alt="图像描述" />
    </div>
    <script src="anotherscript.js"></script>
  </body>
</html>
```

### 解析
TCP 数据包在传输过程中，`数据会被分为若干段`，`一旦浏览器收到第一块数据`，就开始了`解析工作`。这个解析，指的是，通过接收数据，`转换成DOM 和CSSOM 的步骤`,通过渲染器把DOM和CSSOM 在`屏幕上绘制成页面`。

#### DOM构建
`DOM 树描述了文档的内容`。<html> 元素是`第一个标签也是文档树的根节点`。树反映了不同标记之间的关系和层次结构。嵌套在其他标记中的标记是子节点。DOM 节点的数量越多，构建 DOM 树所需的时间就越长。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/72116a07a073457faa61bbf455194aa3.png)
在DOM解析过程中，会遇到图片、脚本、样式文件等资源，如LINK标签为CSS样式文件、script为脚本。这些资源对解析影响是不同的。

如果遇到CSS文件，解析器会继续进行。`CSS文件会构建成CSSOM` ，`CSSOM 和DOM `构建是`并行的`。

但如果`遇到没有 defer或者async 字段的脚本`，`DOM树解析会停止`，`直到将脚本执行完毕后`，才接着执行解析任务。虽然预加载扫描器会优化这个过程，但过多的脚本仍然是一个重要的瓶颈。

浏览器为了优化解析DOM，其他资源带来的阻塞问题，引入了`预加载扫描器`技术

#### 预加载扫描器
浏览器在构建DOM 的时候，占用了主线程，`同时预加载扫码器也在将后台运行`，他会扫`描整一个HTML文件`，如果遇到`css、JavaScript或者web字体`，会在后台发起`资源请求并下载`。等到DOM`解析器解析`到这些`文件的引用的时候`，可能这些`文件已经下载完毕`或者`已经在运行`。这样就减少了阻塞

```html
<link rel="stylesheet" href="styles.css" />
<script src="myscript.js" async></script>
<img src="myimage.jpg" alt="图像描述" />
<script src="anotherscript.js" async></script>
```
在上面的例子中，当主线程解析HTML和CSS 时，预加载扫描器发现了脚本和图像，并开始下载他们。为了确认脚本不会阻塞进程，当JavaScript解析和执行顺序不重要时，可以添加async 或defer属性。

`等待获取 CSS` `不会阻塞 HTML 的解析或者下载`，但是它确实`会阻塞 JavaScript执行`，因为 JavaScript 经常用于查询元素的 CSS 属性。也就是说，当遇到CSS时，不会影响主线程解析DOM，但会阻塞JavaScript文件加载。

#### CSSOM 构建
在解析DOM 时，会并行解析CSS，并进行CSSOM 的构建，CSSOM对象模型和DOM是相似的。但DOM和CSSOM是独立的两棵树，数据结构是独立的。

浏览器将CSS规则转换为可以理解和使用的样式映射。浏览器遍历CSS中每个规则集，根据css选择器创建具有父子级、兄弟关系的节点树。

构建时间CSSOM的速度很快，其时间通常小于一次DNS查询所需时间。

#### 其他过程

##### JavaScript编译
在解析css 和创建CSSOM 的同时，包括JavaScript文件在内的资源也会在下载。
JavaScript下载完之后，`会被解析、编译和解释`。脚本被`解析为抽象语法树`。
有些浏览器会`将抽象语法树输入编译器`，`输出字节码`，这就是`所谓的编译`。大部分代码是在主线程上解释的。
##### 构建无障碍树
浏览器还构建辅助设备用于分析和解释内容的无障碍树。无障碍对象模型（AOM）类似于 DOM 的语义版本。当 DOM 更新时，浏览器会更新辅助功能树。辅助技术本身无法修改无障碍树。
### 渲染
等待DOM和CSSOM 构建完毕，渲染开始，其步骤包括样式、布局、绘制，在某些情况下还包含合成。

CSSOM 和 CSSOM 树会`组合成一个渲染树`，然后浏览器用这个树，计算`每一个可见元素的布局`，然后将`其绘制到屏幕上`。
在某些情况下，我们可以`将内容提升到她们自己的层并进行合成`，`通过GPU而不是CPU`绘制到屏幕的一部分来`提高性能`，从而释放主线程。

#### 样式
下面的元素将不会被显示，如<head>元素及其子元素，以及任何带有display：none 的节点。但visibility：hidden 会被渲染，并占用空间。

每个可见节点都会匹配对应的CSSOM规则，与此确定每个节点的计算样式。
#### 布局
渲染树上运行布局运行，是计算每个节点的高度、宽度、和位置。以及确认页面上每个对象的大小和位置的过程。

`第一次确定节点的大小和位置`称为`布局`。随后`对节点大小和位置的重新计算`称为`回流`。在我们的示例中，假设`初始的布局发生在图片之前`，`由于我们没有声明图片的尺寸`，因此`一旦知道图片的尺寸`，就会`出现回流`。

#### 绘制
最后一步是将节点绘制到屏幕上，第一次出现的节点名称为first meningful paint。在绘制或者光栅化阶段，浏览器会将在`布局阶段计算好`的每个框`转换成屏幕实际的像素`。

绘制包括将元素的每个可视部分绘制到屏幕，包含文本、颜色、边框、阴影等

#### 合成
当文档每个部分以不同层绘制的时候，相互重叠，必须进行合成绘制，以确保正确的顺序绘制到屏幕上。


### 交互
一旦主线程绘制完成，可能主线程还没准备好给我交互的机会，因为可能还需要加载JavaScript（延迟到onload事件执行），这个时候是无法用于滚动、触摸和其他交互。


## 回流
当DOM发生变化，引起元素几何信息发生改变的时候（如大小和位置），浏览器需要重新计算几何属性，会触发回流，使得最新的元素布局渲染到页面上。

回流是一个`成本较高的操作`，因为它可能会`导致整个页面`或者页面`大部分布局`重新计算。

`一个元素的回流`可能会引起他`所有的子元素`、`后续兄弟`以及`祖先节点`的回流。

### 引发回流的属性
引发回流的属性主要包括集合属性和影响布局的属性，以下是一些常见的属性和方法

 - 几何属性的变化，width、height、border、font-size属性发生变化时，会发生回流
 - 窗口大小变化：该表浏览器窗口大小或者滚动位置也会引发回流
 - 增加或者移除样式表文件：动态添加或者移除标签引用的css文件会触发回流。
 - 内容变化：例如在<input >标签输入文字、或者修改DOM元素的文本内容、可能会导致元素尺寸变化，引发回流
 - 激活css伪类：如鼠标停顿触发hover类
 - 操作class属性：通过JavaScript新增或者减少元素的class属性，从而改变元素的样式，可能会引发回流。

### 减少回流

 - 将需要修改的属性`封装到class 类中`。
	`尽量一次性更改元素`的样式，而`不是逐项更改`。我们可以通过`定义一个新的class`，然后将这个class`应用到元素上`实现。
 - 使用`css属性简写`
 使用css简写可以减少重绘和回流的次数。例如，使用border代替单独的border-with、border-style、border-color
 - 避免使用`table布局`
	table布局中，一旦触发回流，表格所有元素都会发生回流
	
 - DOM离线处理
  即在当前真实DOM 树之外，创建一份新的文本，在内存中创建和修改节点，然后再将他们新增到文档中，这样避免回流和重绘次数。
  
  具体步骤如下：
  	
  	1.创建一个新的document对象，用于内存操作DOM
  	2.将要修改的DOM元素从当前文档移除，并添加到新的Document对象中
  	3.对新的文档对象进行DOM的修改操作
  	4将修改后的DOM元素从新的document移除，并添加会原始的文档中
示例代码如下

```javascript
// 获取要修改的列表项
var listItem = document.getElementById('list-item');

// 创建一个新的Document对象
var newDoc = document.implementation.createHTMLDocument();

// 将要修改的列表项从当前文档中移除，并添加到新的Document对象中
newDoc.body.appendChild(listItem);

// 对新Document对象中的列表项进行修改
newDoc.body.style.backgroundColor = 'red';

// 将修改后的列表项从新的Document对象中移除，并添加回原始文档中
document.body.appendChild(listItem);
```

 - 脱离文档流
 将一些`持续性动画效果`，可以使用`float、position：absolute`使其`脱离文档`流，从而`减少页面回流和重绘次数`。

## 重绘
重绘是浏览器根据`元素最新的样式重新绘制界面`。当元素的`颜色`。`背景色`、`边框`等`不影响布局`的 `属性`发生变化的时候，会`触发重绘`。重绘消耗的成本较低，因为他只涉及到重新绘制元素的外观。


## 小结

 - 页面渲染流程包含DNS查询、TCP握手、TLS握手、响应、解析、渲染流程
 - 解析过程会构建DOM、CSSOM，两者是同步进行的，遇到脚本，还有进行脚本`解析、编译、解释`
 - 当`构建DOM` 遇到 `普通脚本`（`非defer或async`）会`阻塞DOM构建`，直至其加载并执行完毕
 - 当遇到`css `文件时，`不会阻塞DOM构建`，但`会阻塞JavaScript脚本执行`
 - 构建完DOM后，`并不是立马可以进行交互`，因为有可能还有`异步脚本需要加载和执行`，或者某些脚本`注册了onload事件`，将会执行这些代码。
 - `预加载扫码器`会`优化一部分资源加载和执行`
 - 渲染节点，需要DOM和CSSOM 一起结合生产渲染树，这个是浏览器进行样式、布局、绘制、合成的基础
 - 回流发生在布局发生变化时，重绘发生在不影响布局的属性发生变化，重新绘制页面
 - 发生回流一定会引起重绘

